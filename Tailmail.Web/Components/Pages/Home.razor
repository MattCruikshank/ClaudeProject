@page "/"
@rendermode InteractiveServer
@using Tailmail.Web.Services
@using Microsoft.AspNetCore.Components
@inject MessageStore MessageStore
@inject NavigationService NavigationService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>Tailmail</PageTitle>

<h1>Tailmail Messages</h1>

@if (!messages.Any())
{
    <p>No messages yet. Send a message using the CLI!</p>
}
else
{
    <div class="messages">
        @foreach (var message in messages)
        {
            <div class="message-card">
                <div class="message-header">
                    <strong>@message.Sender</strong>
                    <span class="timestamp">@FormatTimestamp(message.Timestamp)</span>
                </div>
                <div class="message-content">@message.Content</div>
            </div>
        }
        <div @ref="messagesEnd"></div>
    </div>
}

@code {
    private List<Tailmail.Protos.MessageRequest> messages = new();
    private ElementReference messagesEnd;
    private DotNetObjectReference<Home>? dotNetHelper;

    protected override void OnInitialized()
    {
        LoadMessages();
        MessageStore.OnMessageAdded += OnMessageReceived;
        dotNetHelper = DotNetObjectReference.Create(this);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("setupNavigationKeys", dotNetHelper);
        }
        await ScrollToBottom();
    }

    private void OnMessageReceived()
    {
        InvokeAsync(async () =>
        {
            LoadMessages();
            StateHasChanged();
            await ScrollToBottom();
        });
    }

    private async Task ScrollToBottom()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("scrollToBottom", messagesEnd);
        }
        catch
        {
            // Ignore errors if JS interop isn't ready yet
        }
    }

    private void LoadMessages()
    {
        messages = MessageStore.GetMessages()
            .OrderBy(m => m.Timestamp)
            .ToList();
    }

    private string FormatTimestamp(long timestamp)
    {
        var dt = DateTimeOffset.FromUnixTimeSeconds(timestamp).ToLocalTime();
        return dt.ToString("yyyy-MM-dd HH:mm:ss");
    }

    [JSInvokable]
    public void OnNavigationKey(bool moveUp)
    {
        var nextItem = NavigationService.GetNextItem("", moveUp);

        if (nextItem == string.Empty)
        {
            Navigation.NavigateTo("/");
        }
        else
        {
            Navigation.NavigateTo($"/sender/{Uri.EscapeDataString(nextItem)}");
        }
    }

    public void Dispose()
    {
        MessageStore.OnMessageAdded -= OnMessageReceived;
        dotNetHelper?.Dispose();
    }
}

<style>
    .messages {
        margin-top: 20px;
    }

    .message-card {
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 10px;
        background-color: #f9f9f9;
    }

    .message-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-size: 14px;
    }

    .timestamp {
        color: #666;
    }

    .message-content {
        font-size: 16px;
    }
</style>
